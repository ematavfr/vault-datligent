# üéØ Guide de Workflow Quotidien - Vault MCP pour Outils IA

## üìñ Philosophie

Au lieu de stocker vos cl√©s API en dur dans chaque configuration MCP, **centralisez-les dans Vault** et laissez vos outils IA les r√©cup√©rer dynamiquement quand ils en ont besoin.

## üîÑ Workflow Standard

### √âtape 1 : Stockez vos cl√©s dans Vault (une seule fois)

```bash
# Ajouter votre cl√© DeepL
./scripts/add-mcp-secret.sh deepl api_key="votre-vraie-cl√©-deepl"

# Ajouter votre token GitHub
./scripts/add-mcp-secret.sh github token="ghp_votre_token_r√©el"

# Ajouter vos credentials Composio
./scripts/add-mcp-secret.sh composio \
  api_key="votre-cl√©-composio" \
  entity_id="votre-entity-id"

# Ajouter votre cl√© Anthropic
./scripts/add-mcp-secret.sh anthropic api_key="sk-ant-votre-cl√©"
```

### √âtape 2 : Utilisez vos outils IA normalement

Vos outils IA (Claude Code, Cursor, etc.) peuvent maintenant r√©cup√©rer les cl√©s en temps r√©el.

## üíº Cas d'Usage Quotidiens

### üåê Cas 1 : Configurer un nouveau serveur MCP

**Sc√©nario** : Vous voulez utiliser le serveur MCP DeepL dans Claude Code

**Ancienne m√©thode (sans Vault)** :
1. Chercher votre cl√© DeepL dans vos notes/emails
2. La copier dans la configuration MCP
3. Risque : cl√© en clair dans le fichier de config

**Nouvelle m√©thode (avec Vault)** :

**Vous dites √† Claude Code :**
```
"Configure le serveur MCP DeepL pour moi"
```

**Claude Code ex√©cute automatiquement :**
1. *"R√©cup√®re ma cl√© API DeepL depuis Vault"*
2. Obtient la cl√© de mani√®re s√©curis√©e
3. Configure le serveur MCP avec la cl√©
4. Supprime la cl√© de la m√©moire apr√®s usage

**R√©sultat** : Configuration s√©curis√©e sans exposer votre cl√© !

---

### üîß Cas 2 : Utiliser une API dans un script

**Sc√©nario** : Vous d√©veloppez un script qui utilise l'API GitHub

**Vous dites √† Claude Code :**
```
"√âcris un script Python qui liste mes repos GitHub.
Utilise le token depuis Vault."
```

**Claude Code g√©n√®re :**

```python
#!/usr/bin/env python3
import os
import subprocess
import json
import requests

# R√©cup√©rer le token depuis Vault via Claude
# Note: Claude a d√©j√† r√©cup√©r√© le token de mani√®re s√©curis√©e

def get_github_token():
    """
    Cette fonction serait appel√©e par Claude pour r√©cup√©rer
    le token depuis Vault de mani√®re s√©curis√©e
    """
    # Claude ex√©cute: vault kv get -field=token datligent/mcp/shared/github
    return os.environ.get('GITHUB_TOKEN')

def list_repos():
    token = get_github_token()
    headers = {'Authorization': f'token {token}'}

    response = requests.get(
        'https://api.github.com/user/repos',
        headers=headers
    )

    if response.status_code == 200:
        repos = response.json()
        for repo in repos:
            print(f"üì¶ {repo['name']} - {repo['html_url']}")
    else:
        print(f"‚ùå Erreur: {response.status_code}")

if __name__ == '__main__':
    list_repos()
```

**Avantage** : Pas de token en dur dans le code !

---

### üîÑ Cas 3 : Rotation de cl√©s API

**Sc√©nario** : Vous devez changer votre cl√© OpenAI compromise

**Vous dites √† Claude Code :**
```
"Ma cl√© OpenAI a √©t√© compromise.
G√©n√®re une nouvelle cl√© et mets √† jour Vault."
```

**Claude Code :**
1. Vous guide pour g√©n√©rer une nouvelle cl√© sur OpenAI
2. *"Mets √† jour le secret OpenAI dans Vault avec la nouvelle cl√©"*
3. Tous vos outils (Claude Code, Cursor, etc.) utilisent instantan√©ment la nouvelle cl√©

**Commande manuelle alternative :**
```bash
./scripts/add-mcp-secret.sh openai api_key="sk-nouvelle-cl√©"
```

---

### üîç Cas 4 : V√©rifier vos secrets disponibles

**Vous dites √† Claude Code :**
```
"Quels secrets MCP sont disponibles dans Vault ?"
```

**Claude Code ex√©cute :**
```bash
./scripts/list-mcp-secrets.sh
```

**R√©sultat affich√© :**
```
üîê Secrets MCP disponibles dans Vault

üìã Liste des services configur√©s:

üì¶ Service: deepl
   Path: datligent/mcp/shared/deepl
   Cl√©s:
      ‚Ä¢ api_key: votre-cl...
   Metadata:
      ‚Ä¢ Version: 2
      ‚Ä¢ Cr√©√©: 2025-10-01T08:30:00Z

üì¶ Service: github
   Path: datligent/mcp/shared/github
   ...
```

---

### üöÄ Cas 5 : Partager une configuration entre outils

**Sc√©nario** : Vous utilisez la m√™me cl√© API Anthropic dans Claude Code et Cursor

**Une seule fois :**
```bash
./scripts/add-mcp-secret.sh anthropic api_key="sk-ant-votre-cl√©"
```

**Ensuite, dans Claude Code :**
```
"R√©cup√®re ma cl√© Anthropic depuis Vault pour configurer le MCP"
```

**Ensuite, dans Cursor :**
```
"R√©cup√®re ma cl√© Anthropic depuis Vault pour configurer le MCP"
```

**R√©sultat** : Les deux outils utilisent la m√™me cl√©, stock√©e une seule fois !

---

### üõ†Ô∏è Cas 6 : D√©velopper avec plusieurs environnements

**Sc√©nario** : Vous avez des cl√©s diff√©rentes pour dev/staging/prod

**Structure dans Vault :**
```bash
# D√©veloppement
./scripts/add-mcp-secret.sh stripe-dev api_key="sk_test_..."

# Staging
./scripts/add-mcp-secret.sh stripe-staging api_key="sk_test_staging_..."

# Production
./scripts/add-mcp-secret.sh stripe-prod api_key="sk_live_..."
```

**Usage :**
```
"Utilise la cl√© Stripe dev pour tester le paiement"
"Utilise la cl√© Stripe prod pour le d√©ploiement"
```

---

## üìã Workflows Sp√©cifiques par Outil

### Claude Code

#### Configuration initiale
```
"Liste mes secrets MCP disponibles"
"Configure tous mes serveurs MCP avec les cl√©s depuis Vault"
```

#### Usage quotidien
```
"R√©cup√®re ma cl√© DeepL et traduis ce texte en fran√ßais"
"Utilise mon token GitHub pour cr√©er un nouveau repo"
"Avec ma cl√© Composio, r√©cup√®re mes emails Gmail"
```

### Cursor

#### Configuration
```
"Configure le serveur MCP Vault pour Cursor"
"R√©cup√®re tous mes secrets MCP depuis Vault"
```

#### Usage quotidien
```
"Utilise ma cl√© GitHub pour push ce code"
"R√©cup√®re ma cl√© OpenAI pour g√©n√©rer des tests"
```

### Gemini-CLI

```bash
# Configuration (une fois)
gemini "Configure MCP Vault avec le token depuis ~/vault-datligent/init-data/ai-tools-token.txt"

# Usage
gemini "R√©cup√®re ma cl√© DeepL depuis Vault"
gemini "Liste tous mes secrets MCP"
```

### Codex

```bash
# Configuration (une fois)
codex setup vault-mcp

# Usage
codex "Utilise mon token GitHub depuis Vault pour cloner ce repo"
```

---

## üîê Bonnes Pratiques de S√©curit√©

### ‚úÖ √Ä FAIRE

1. **Stockez les cl√©s dans Vault d√®s leur cr√©ation**
   ```bash
   ./scripts/add-mcp-secret.sh nouveau-service api_key="..."
   ```

2. **Utilisez des commandes naturelles pour r√©cup√©rer les cl√©s**
   ```
   "R√©cup√®re ma cl√© X depuis Vault"
   ```

3. **Ne hardcodez jamais les cl√©s dans le code**
   ```python
   # ‚ùå MAUVAIS
   API_KEY = "sk-1234567890abcdef"

   # ‚úÖ BON
   # Claude r√©cup√®re depuis Vault au moment de l'ex√©cution
   ```

4. **Rotez r√©guli√®rement vos secrets**
   ```bash
   # Tous les 90 jours
   ./scripts/add-mcp-secret.sh service api_key="nouvelle-cl√©"
   ```

5. **Auditez les acc√®s**
   ```bash
   # Voir qui acc√®de √† quoi
   vault audit enable file file_path=/vault/logs/audit.log
   ```

### ‚ùå √Ä √âVITER

1. **Ne copiez pas les cl√©s dans les messages de chat**
2. **Ne commitez jamais de cl√©s dans Git**
3. **N'envoyez pas de cl√©s par email/Slack**
4. **Ne stockez pas de cl√©s en clair dans les fichiers de config**
5. **N'utilisez pas le token root pour les applications**

---

## üé¨ Sc√©narios Complets de Workflow

### Sc√©nario A : Nouveau Projet avec APIs Multiples

**Objectif** : Cr√©er un projet qui utilise GitHub, OpenAI et Stripe

**√âtape 1 - Pr√©parer les secrets (une fois)**
```bash
./scripts/add-mcp-secret.sh github token="ghp_..."
./scripts/add-mcp-secret.sh openai api_key="sk-..."
./scripts/add-mcp-secret.sh stripe-dev api_key="sk_test_..."
```

**√âtape 2 - D√©velopper avec Claude Code**
```
"Cr√©e un projet Next.js qui :
1. Clone un template depuis GitHub (utilise mon token Vault)
2. G√©n√®re du contenu avec OpenAI (utilise ma cl√© Vault)
3. Int√®gre Stripe pour les paiements (utilise ma cl√© dev Vault)"
```

**Claude Code va :**
- R√©cup√©rer automatiquement les 3 cl√©s depuis Vault
- Les utiliser dans le code de mani√®re s√©curis√©e
- Ne jamais les exposer en clair

**√âtape 3 - Partager avec l'√©quipe**
Vos coll√®gues ajoutent leurs propres cl√©s dans leur Vault local et le code fonctionne imm√©diatement !

---

### Sc√©nario B : Migration d'un Projet Existant

**Situation** : Vous avez un projet avec des cl√©s en dur dans `.env`

**Fichier `.env` actuel :**
```bash
GITHUB_TOKEN=ghp_hardcoded_token_here
OPENAI_API_KEY=sk-hardcoded_key_here
STRIPE_KEY=sk_test_hardcoded
```

**Migration vers Vault :**

**√âtape 1 - Importer dans Vault**
```bash
# Lire les cl√©s depuis .env et les importer
source .env
./scripts/add-mcp-secret.sh github token="$GITHUB_TOKEN"
./scripts/add-mcp-secret.sh openai api_key="$OPENAI_API_KEY"
./scripts/add-mcp-secret.sh stripe-dev api_key="$STRIPE_KEY"
```

**√âtape 2 - Modifier le code**

**Vous dites √† Claude Code :**
```
"Modifie le projet pour utiliser Vault au lieu de .env :
1. Cr√©e un script qui r√©cup√®re les secrets depuis Vault
2. Remplace toutes les r√©f√©rences √† process.env par les secrets Vault
3. Supprime le fichier .env"
```

**√âtape 3 - Documenter**
```
"Cr√©e un README expliquant comment configurer Vault pour ce projet"
```

---

### Sc√©nario C : Travail Multi-Outils

**Situation** : Vous alternez entre Claude Code, Cursor et terminal

**Matin - Claude Code**
```
"Liste mes secrets MCP"
"Utilise ma cl√© OpenAI pour g√©n√©rer des tests"
```

**Apr√®s-midi - Cursor**
```
"R√©cup√®re ma cl√© GitHub depuis Vault"
"Push le code avec authentification"
```

**Soir - Terminal direct**
```bash
source .env.vault
export VAULT_TOKEN="$VAULT_AI_TOOLS_TOKEN"
vault kv get datligent/mcp/shared/github
```

**R√©sultat** : Exp√©rience fluide, m√™mes cl√©s partout !

---

## üîÑ Maintenance R√©guli√®re

### Hebdomadaire

```bash
# V√©rifier les secrets disponibles
./scripts/list-mcp-secrets.sh

# V√©rifier l'expiration du token
source .env.vault
export VAULT_TOKEN="$VAULT_AI_TOOLS_TOKEN"
vault token lookup | grep ttl
```

### Mensuelle

```bash
# Renouveler le token AI tools
vault token renew

# Auditer les acc√®s
vault read sys/audit

# Sauvegarder Vault
docker exec vault-datligent vault operator raft snapshot save backup.snap
```

### Trimestrielle (90 jours)

```bash
# Rotation de tous les secrets
./scripts/add-mcp-secret.sh deepl api_key="nouvelle-cl√©-deepl"
./scripts/add-mcp-secret.sh github token="nouveau-token-github"
# ... autres services
```

---

## üìä Comparaison Avant/Apr√®s

### ‚ùå AVANT (sans Vault)

```
üìÅ projet/
‚îú‚îÄ‚îÄ .env                    # ‚ö†Ô∏è Cl√©s en clair
‚îú‚îÄ‚îÄ .env.local             # ‚ö†Ô∏è Cl√©s en clair
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ api-keys.json      # ‚ö†Ô∏è Cl√©s en clair
‚îî‚îÄ‚îÄ .gitignore             # ü§û Esp√®re que .env est ignor√©
```

**Probl√®mes :**
- ‚ùå Cl√©s √©parpill√©es dans plusieurs fichiers
- ‚ùå Risque de commit accidentel
- ‚ùå Difficile de partager avec l'√©quipe
- ‚ùå Pas d'audit des acc√®s
- ‚ùå Rotation manuelle et fastidieuse

### ‚úÖ APR√àS (avec Vault)

```
üìÅ projet/
‚îú‚îÄ‚îÄ .env.vault             # ‚úÖ Juste l'adresse Vault + token
‚îî‚îÄ‚îÄ README.md              # ‚úÖ Instructions Vault
```

**Avantages :**
- ‚úÖ Une seule source de v√©rit√©
- ‚úÖ Impossible de committer des secrets
- ‚úÖ Partage s√©curis√© avec l'√©quipe
- ‚úÖ Audit centralis√©
- ‚úÖ Rotation en une commande

---

## üéØ Commandes √† Conna√Ætre par C≈ìur

### Gestion des secrets
```bash
# Ajouter un secret
./scripts/add-mcp-secret.sh <service> key="value"

# Lister tous les secrets
./scripts/list-mcp-secrets.sh

# Voir un secret sp√©cifique
vault kv get datligent/mcp/shared/<service>
```

### Depuis vos outils IA (langage naturel)
```
"Liste mes secrets MCP"
"R√©cup√®re ma cl√© API <service> depuis Vault"
"Mets √† jour mon token <service> dans Vault"
"Cr√©e un nouveau secret pour <service>"
```

### Maintenance Vault
```bash
# Statut
docker ps | grep vault-datligent

# Renouveler le token
vault token renew

# Backup
docker exec vault-datligent vault operator raft snapshot save backup.snap
```

---

## üí° Astuces Pro

### Astuce 1 : Alias pratiques

Ajoutez √† votre `~/.bashrc` ou `~/.zshrc` :

```bash
# Alias Vault
alias vlist='cd ~/vault-datligent && ./scripts/list-mcp-secrets.sh'
alias vadd='cd ~/vault-datligent && ./scripts/add-mcp-secret.sh'
alias venv='source ~/vault-datligent/.env.vault'

# Utilisation
vlist              # Lister les secrets
vadd service key="value"   # Ajouter un secret
venv               # Charger l'environnement Vault
```

### Astuce 2 : Templates de secrets

Cr√©ez des templates pour vos services communs :

```bash
# ~/vault-datligent/templates/add-stripe.sh
./scripts/add-mcp-secret.sh stripe-dev \
  api_key="$1" \
  publishable_key="$2" \
  webhook_secret="$3"
```

Usage :
```bash
~/vault-datligent/templates/add-stripe.sh "sk_test_..." "pk_test_..." "whsec_..."
```

### Astuce 3 : V√©rification pre-commit

Cr√©ez un git hook qui v√©rifie qu'aucune cl√© n'est commit√©e :

```bash
# .git/hooks/pre-commit
#!/bin/bash

# V√©rifier qu'aucune cl√© API n'est dans le commit
if git diff --cached | grep -E "(api_key|secret|token|password).*=.*['\"][A-Za-z0-9]{20,}"; then
    echo "‚ùå D√©tection de secret potentiel dans le commit!"
    echo "üí° Utilisez Vault: ./scripts/add-mcp-secret.sh"
    exit 1
fi
```

### Astuce 4 : Environnements multiples

```bash
# Structure pour dev/staging/prod
./scripts/add-mcp-secret.sh api-dev key="..."
./scripts/add-mcp-secret.sh api-staging key="..."
./scripts/add-mcp-secret.sh api-prod key="..."

# Variable d'environnement pour choisir
export ENV=dev
# Vos outils utilisent automatiquement api-$ENV
```

---

## üÜò D√©pannage Courant

### Probl√®me : "Vault ne r√©pond pas"

```bash
# V√©rifier Vault
docker ps | grep vault-datligent

# Red√©marrer si n√©cessaire
docker-compose -f docker-compose-simple.yml restart
```

### Probl√®me : "Token expir√©"

```bash
# Renouveler
source .env.vault
export VAULT_TOKEN="$VAULT_AI_TOOLS_TOKEN"
vault token renew

# Si trop tard, recr√©er
export VAULT_TOKEN="$VAULT_ROOT_TOKEN"
vault token create -policy=ai-tools-mcp-access -ttl=768h -renewable
```

### Probl√®me : "Secret non trouv√©"

```bash
# V√©rifier le chemin exact
vault kv list datligent/mcp/shared

# Cr√©er si manquant
./scripts/add-mcp-secret.sh service key="value"
```

### Probl√®me : "Permission denied"

```bash
# V√©rifier les permissions du token
vault token capabilities datligent/mcp/shared/service

# V√©rifier la politique
vault policy read ai-tools-mcp-access
```

---

## üìö Ressources Compl√©mentaires

- **Guide de d√©marrage** : `QUICKSTART.md`
- **Documentation compl√®te** : `AI-TOOLS-VAULT-SETUP.md`
- **Scripts disponibles** : `scripts/`
- **Interface Web Vault** : http://localhost:8200/ui/

---

## ‚ú® En R√©sum√©

**Principe cl√©** :
> Stockez une fois dans Vault, utilisez partout avec des commandes naturelles

**Workflow quotidien** :
1. üì¶ Stockez vos cl√©s dans Vault (une fois)
2. üí¨ Demandez √† vos outils IA de les r√©cup√©rer (en langage naturel)
3. üîí Vos cl√©s restent s√©curis√©es et centralis√©es
4. üîÑ Rotez facilement quand n√©cessaire

**B√©n√©fice final** :
> Plus de cl√©s en dur, plus de risque de fuite, workflow fluide entre tous vos outils IA !

---

*Guide cr√©√© le 2025-10-01 pour l'√©cosyst√®me Datligent*
